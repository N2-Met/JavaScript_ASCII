<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>アスキーアート動画変換</title>
    <script>
        let canvas, context, video; //キャンバス、ビデオ
        let sTime = 0, eTime = 0; //開始位置、終了位置(startTime endTime)
        let timer;

        //初期化　　　　　　　init=初期化
        const init = () => {
            //キャンバス、ビデオ要素の取得
            canvas = document.getElementById("image");//一時描画用キャンバスの取得
            context = canvas.getContext("2d");
            video = dovument.getElementById("video");
            //変換ボタンの無効化
            video = document.getElementById("convert").disabled = true;
        }

        //動画の読み込み
        const loadVideo = files => {
            //files 「ファイルを選択」ボタンで指定した動画ファイル
            video.src = URL.createObjectURL(files[0]);
            video.onloadedmetadata = () => {
                let maxTime = video.duration; //動画の最大時間を取得　duration:間隔
                //再生時間を取得し、プログレスバーとスライダーにセット。取得できない場合、10秒に設定
                if (!isFinite(maxTime)) maxTime = 10; // isFinite() 値が有限か否か判断する。有限出ない場合、10秒に設定
                document.getElementById("time").max = maxTime;
                document.getElementById("time_0").max = maxTime;
                document.getElementById("time_1").max = maxTime;
            }

            //再生位置を表示
            video.ontimeupdate = () => {
                //動画の再生位置が変化した時、再生位置をプログレスバーにセットし、秒数を表示
                const sec = video.currentTime;
                document.getElementById("time").value = video.currentTime;
                document.getElementById("sec").innerText = sec.toFixed(1);
            }
        }

        const setRange = n => {
            //位置を取得
            const time = document.getElementById('time_${n}').value//値を変更したスライダーの値を取得
            document.getElementById('sec_${n}').innerText = time;
            video.currentTime = time;
            //再生区間をセット
            sTime = Number(document.getElementById("time_0").value);
            eTime = Number(document.getElementById("time_1").value);
            if (sTime > eTime) [sTime, eTime] = [eTime, sTime];
            document.getElementById("sSec").innerText = sTime;  //開始位置を表示
            document.getElementById("eSec").innerText = sTime;  //終了位置を表示
            //変換ボタンの有効化
            document.getElementById("convert").disabled = false; //disabled →無効化。　falseで有効化
            if (sTime == eTime) {
                document.getElementById("convert").disabled = true;
            }
        }

        const startConvert = () => {
            //変換開始
            video.currentTime = sTime; //動画の再生位置に開始位置をセット
            video.play(); //動画を再生
            timer = setInterval(capture, 100);  //100ミリ秒(0.1秒)ごとにcapture関数を実行。capture関数:動画をAAへ変換
            document.getElementById("convert").disabled = true;
        }


        //動画のキャプチャ、アスキーアートへの変換
        const capture = () => {
            if (video.currentTime < eTime) {
                const [sw, sh] = [video.videoWidth, video.videoHeight];
                const dw = 54 * sw / sh;
                const dx = (canvas.width - dw) / 2;
                context.drawImage(video, 0, 0, sw, sh, dx, 0, dw, canvas.height);
                convertAA();
            }else{
                stopConvert();
            }
        }



    </script>
</head>

</html>
